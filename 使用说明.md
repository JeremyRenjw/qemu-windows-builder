# 生态系统应用VM镜像构建 - 使用说明

## 🎯 项目概述

本项目基于PDF文档《Build Ecosystem Application VM Image》要求，使用本地Windows 10 Enterprise 22H2 ISO文件构建生态系统应用虚拟机镜像。

### ✨ 特性亮点
- **500GB大容量磁盘** (根据用户要求)
- **16GB内存 + 12核CPU** (增强配置)
- **丰富的生态系统软件** (开发工具、数据库、容器等)
- **一键自动化构建** (无需手动干预)
- **符合PDF文档要求** (用户账户、配置等)

## 🚀 快速开始

### 最简单的方式 (推荐)

```bash
# 1. 赋予执行权限
chmod +x quick-start.sh

# 2. 运行快速构建
./quick-start.sh
```

### 详细控制方式

```bash
# 1. 使用本地ISO构建
chmod +x build-with-local-iso.sh
./build-with-local-iso.sh
```

## 📋 系统要求

### 硬件要求
- **CPU**: 支持Intel VT-x或AMD-V硬件虚拟化
- **内存**: 至少32GB RAM (推荐48GB+)
- **存储**: 至少600GB可用磁盘空间
- **网络**: 稳定的互联网连接用于下载软件

### 软件要求
- **操作系统**: Ubuntu 24.04.2 LTS
- **权限**: 具备sudo权限的用户账户
- **BIOS设置**: 已启用CPU虚拟化功能

## 📁 文件说明

| 文件名 | 描述 | 用途 |
|--------|------|------|
| `quick-start.sh` | 快速启动脚本 | 最简单的一键构建方式 |
| `build-with-local-iso.sh` | 完整构建脚本 | 使用本地ISO文件的详细构建流程 |
| `start-ecosystem-vm.sh` | VM启动脚本 | 构建完成后启动虚拟机 |
| `README_BUILD.md` | 详细构建指南 | 完整的技术文档 |
| `pdf_images/` | PDF转换图片 | PDF文档内容的图片版本 |

## ⚙️ 配置信息

### VM配置
- **名称**: ecosystem-application-vm
- **磁盘**: 500GB QCOW2格式
- **内存**: 16GB
- **CPU**: 12核
- **网络**: VirtIO网卡 + 端口转发

### 用户账户 (符合PDF要求)
- **管理员**: `philips` / `philips`
- **普通用户**: `user` / `vmuser123`

### 网络端口
- **RDP**: localhost:3389 → VM:3389
- **WinRM**: localhost:5985 → VM:5985

## 📦 预装软件清单

### 🛠️ 开发环境
- **.NET SDK**: 6.0, 8.0
- **Java**: OpenJDK 17 + Maven + Gradle
- **Node.js**: 最新LTS + Yarn
- **Python**: 最新版本

### 💻 开发工具
- **IDE**: VS Code, IntelliJ IDEA Community
- **编辑器**: Notepad++
- **版本控制**: Git, GitHub Desktop, Git Extensions

### 🗄️ 数据库工具
- **MySQL**: MySQL Workbench
- **PostgreSQL**: pgAdmin 4
- **MongoDB**: MongoDB Compass

### 🐳 容器和DevOps
- **容器**: Docker Desktop
- **编排**: Kubernetes CLI
- **基础设施**: Terraform
- **云工具**: AWS CLI, Azure CLI

### 🌐 浏览器和工具
- **浏览器**: Google Chrome, Firefox
- **API测试**: Postman, Insomnia
- **文件传输**: PuTTY, WinSCP, FileZilla
- **系统工具**: 7-Zip, Process Explorer, Process Monitor

## ⏱️ 构建时间预估

| 阶段 | 预计时间 | 说明 |
|------|----------|------|
| 环境检查和依赖安装 | 10-20分钟 | 首次运行需要安装Packer和QEMU |
| Windows系统安装 | 30-60分钟 | 取决于硬件性能 |
| 软件包安装 | 60-120分钟 | 取决于网络速度 |
| 系统优化和压缩 | 30-60分钟 | .NET编译和磁盘压缩 |
| **总计** | **2-4小时** | 建议在稳定环境下运行 |

## 🔧 故障排除

### 常见问题

1. **CPU虚拟化未启用**
   ```bash
   # 检查命令
   egrep -c '(vmx|svm)' /proc/cpuinfo
   ```
   如果输出为0，需要在BIOS中启用VT-x/AMD-V

2. **磁盘空间不足**
   ```bash
   # 检查可用空间
   df -h .
   # 清理系统缓存
   sudo apt clean
   sudo apt autoremove
   ```

3. **VNC连接失败**
   - 这是常见问题，通常重新运行构建即可解决
   - 或在脚本中将`HEADLESS="false"`以显示构建过程

4. **WinRM连接超时**
   - 检查防火墙设置
   - 确保网络配置正确
   - 增加超时时间配置

### 调试模式

如果需要调试构建过程：

1. 编辑构建脚本，将`HEADLESS="false"`
2. 观察VM启动和安装过程
3. 检查构建日志文件

## 📊 构建结果

### 输出文件
构建完成后会生成：
```
windows/output-ecosystem-application-vm/
├── ecosystem-application-vm     # 主VM镜像文件 (QCOW2格式)
├── efivars.fd                  # EFI变量文件
└── OVMF_CODE_4M.fd             # UEFI固件代码 (如果需要)
```

### 文件大小
- **原始大小**: 约12-15GB
- **压缩后**: 约8-10GB (启用sdelete压缩)
- **磁盘空间**: 500GB (稀疏分配)

## 🚀 使用虚拟机

### 启动方法
```bash
# 使用生成的启动脚本
./start-ecosystem-vm.sh
```

### 远程连接
```bash
# RDP连接 (推荐)
rdesktop localhost:3389
# 或使用任何RDP客户端连接 localhost:3389

# WinRM连接 (PowerShell)
Enter-PSSession -ComputerName localhost -Port 5985 -Credential (Get-Credential)
```

### 首次使用
1. 虚拟机启动后会自动运行Sysprep
2. 等待`C:\not-yet-finished`文件被删除
3. 使用philips/philips登录管理员账户
4. 开始使用预装的开发工具

## 📤 交付要求

根据PDF文档要求，需要：

1. **打包输出目录**
   ```bash
   cd windows
   zip -r ecosystem-vm-delivery-$(date +%Y%m%d).zip output-ecosystem-application-vm/
   ```

2. **包含文件清单**
   - VM镜像文件
   - EFI变量文件
   - 启动脚本
   - 使用说明

3. **提交给Philips团队**

## 📞 技术支持

### 日志文件
- 构建日志: `build-YYYYMMDD-HHMMSS.log`
- 系统日志: `/var/log/libvirt/qemu/`
- Packer日志: 构建过程中的详细输出

### 性能优化建议
1. 使用SSD存储提高构建速度
2. 分配足够的系统内存
3. 确保网络连接稳定
4. 在非高峰时段进行构建

## 📝 许可和版权

- 本项目基于开源工具构建
- Windows 10 Enterprise需要有效许可证
- 请遵守所有软件的许可协议
- 感谢HashiCorp Packer和QEMU/KVM项目

---

**🎉 恭喜！您现在拥有了一个功能完整的生态系统应用VM镜像构建解决方案！**

有任何问题请查看详细日志文件或参考故障排除部分。